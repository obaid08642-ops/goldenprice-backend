<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin Panel</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px;line-height:1.4}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button{padding:10px;border:1px solid #bbb;border-radius:8px;font-size:16px}
  button{background:#1863ff;color:#fff;border:none}
  .card{border:1px solid #ddd;border-radius:12px;padding:14px;margin:10px 0}
  .k{font-weight:700}
  .ok{color:#0a7}
  .err{color:#c22}
  pre{background:#0b1020;color:#d7e0ff;border-radius:10px;padding:10px;overflow:auto;max-height:240px}
</style>
</head>
<body>
<h2>Admin Panel</h2>

<div class="card">
  <div class="row">
    <input id="base" style="flex:1" placeholder="https://goldenprice-backend.onrender.com"/>
    <button onclick="ping()">Ping</button>
  </div>
  <div class="row" style="margin-top:8px">
    <input id="token" placeholder="ADMIN token" value="ADMIN_12345" />
    <button onclick="refreshAll()">Update All Now</button>
  </div>
</div>

<div class="card" id="quick"></div>

<div class="card">
  <h3>Manual Update</h3>
  <div class="row">
    <select id="cat">
      <option>Gold/Silver</option>
      <option>Crypto</option>
      <option>Metals</option>
      <option>Oil/Gas</option>
      <option>FX</option>
    </select>
    <select id="sym"></select>
  </div>
  <div class="row" style="margin-top:8px">
    <input id="price" placeholder="USD / Rate e.g. 2375.50" style="flex:1"/>
    <button onclick="setManual()">Set Manual</button>
    <button onclick="clearManual()">Clear Manual</button>
  </div>
  <small>For FX: key will be like <b>FX:USD:EGP</b> (choose from dropdown once queried).</small>
</div>

<div class="card">
  <h3>Log Viewer</h3>
  <pre id="logs"></pre>
</div>

<div class="card">
  <h3>Quick test links</h3>
  <div id="links"></div>
</div>

<script>
const $ = id => document.getElementById(id);
const qs = s => document.querySelector(s);

const state = {
  base: localStorage.getItem('base') || location.origin,
  last: null,
  symbols: {
    "Gold/Silver": ["GOLD","SILVER"],
    "Crypto": ["CRYPTO:BTC","CRYPTO:ETH","CRYPTO:SLX"],
    "Metals": ["METAL:COPPER","METAL:PLATINUM","METAL:PALLADIUM"],
    "Oil/Gas": ["ENERGY:WTI","ENERGY:GAS"],
    "FX": ["FX:USD:EGP"]
  }
};

function setup() {
  $('base').value = state.base;
  fillSym();
  renderLinks();
  loadQuick();
}
function saveBase(){
  const v = $('base').value.trim();
  try { new URL(v); state.base = v; localStorage.setItem('base', v); }
  catch { alert("Base URL invalid"); }
}
function ping(){
  saveBase();
  fetch(state.base + '/api/status')
    .then(r=>r.json()).then(j=>{
      $('logs').textContent = JSON.stringify(j,null,2);
      loadQuick();
    }).catch(()=> alert('Ping failed'));
}
function renderLinks(){
  $('links').innerHTML = `
   <a href="${state.base}/api/gold">/api/gold</a><br/>
   <a href="${state.base}/api/silver">/api/silver</a><br/>
   <a href="${state.base}/api/crypto/bitcoin">/api/crypto/bitcoin</a><br/>
   <a href="${state.base}/api/oilgas">/api/oilgas</a><br/>
   <a href="${state.base}/api/metals?list=copper,platinum">/api/metals</a><br/>
   <a href="${state.base}/api/fx?from=USD&to=EGP">/api/fx?from=USD&to=EGP</a><br/>
   <a href="${state.base}/api/status">/api/status</a>
  `;
}
async function loadQuick(){
  const get = k => fetch(`${state.base}${k}`).then(r=>r.json()).catch(_=>({}));
  const [g,s,b,og,m,fx] = await Promise.all([
    get('/api/gold'), get('/api/silver'), get('/api/crypto/bitcoin'),
    get('/api/oilgas'), get('/api/metals?list=copper,platinum'),
    get('/api/fx?from=USD&to=EGP')
  ]);
  function line(lbl, obj){
    const ok = obj && obj.usd>0;
    const src = obj?.source || '';
    const at  = obj?.at || '';
    return `<div><span class="k">${lbl}</span> — ${ok?obj.usd+' USD':'—'} <span class="${ok?'ok':'err'}">${ok?'OK':'ERR'}</span> <small>via ${src} ${at?('at '+new Date(at).toLocaleString()):''}</small></div>`;
  }
  $('quick').innerHTML = `
    <h3>Quick View</h3>
    ${ line('CRYPTO:BTC', b) }
    ${ line('ENERGY:GAS', og.GAS||{}) }
    ${ line('ENERGY:WTI', og.WTI||{}) }
    ${ line('METAL:COPPER', m.COPPER||{}) }
    ${ line('METAL:GOLD', g) }
    ${ line('METAL:PLATINUM', m.PLATINUM||{}) }
    ${ line('SILVER', s) }
  `;
}
function fillSym(){
  const cat = $('cat').value;
  const arr = state.symbols[cat] || [];
  const s = $('sym');
  s.innerHTML = '';
  arr.forEach(x=>{
    const o = document.createElement('option'); o.textContent = x; o.value = x; s.appendChild(o);
  });
}
$('cat').addEventListener('change', fillSym);

async function refreshAll(){
  await fetch(state.base + '/admin/refresh', { method:'POST' })
    .then(r=>r.json()).then(()=>loadQuick()).catch(()=>alert('Refresh failed'));
}

async function setManual(){
  const key = $('sym').value;
  const usd = parseFloat($('price').value);
  if (!key || isNaN(usd)) return alert('Enter key & price');
  const tok = $('token').value.trim();
  const res = await fetch(state.base + '/admin/manual', {
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},
    body: JSON.stringify({ key, usd })
  });
  const j = await res.json();
  if (!res.ok) return alert('ERR: ' + (j.error||res.status));
  $('price').value='';
  loadQuick();
}
async function clearManual(){
  const key = $('sym').value;
  const tok = $('token').value.trim();
  const res = await fetch(state.base + '/admin/manual/' + encodeURIComponent(key), {
    method:'DELETE',
    headers:{'Authorization':'Bearer '+tok}
  });
  const j = await res.json();
  if (!res.ok) return alert('ERR: ' + (j.error||res.status));
  loadQuick();
}

setup();
</script>
</body>
</html>
