<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GoldenPrice â€” Admin (Light)</title>
<style>
  :root{
    --bg:#ffffff;--card:#f6f8fb;--text:#0f172a;--muted:#6b7280;
    --border:#e5e7eb;--primary:#1d4ed8;--primary-ink:#ffffff;
    --ok:#16a34a;--warn:#eab308;--err:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text)}
  header{padding:28px 18px 10px}
  h1{margin:0 0 6px;font-size:28px}
  .sub{color:var(--muted);font-size:14px}
  .wrap{max-width:840px;margin:0 auto 80px;padding:0 18px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
  .row{display:flex;gap:10px;align-items:center}
  .grow{flex:1}
  label{display:block;font-weight:600;margin:0 0 8px}
  input,textarea,select{
    width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;background:#fff;
    font-size:15px;color:var(--text);outline:none
  }
  textarea{min-height:78px;resize:vertical}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .btn{
    border:0;border-radius:10px;background:var(--primary);color:var(--primary-ink);
    padding:11px 16px;font-weight:600;cursor:pointer
  }
  .btn.secondary{background:#0ea5e9}
  .btn.ghost{background:#eef2ff;color:#1e40af}
  .pill{font-size:12px;border-radius:999px;padding:4px 8px;border:1px solid var(--border);background:#fff}
  .kv{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px;background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .line{height:1px;background:var(--border);margin:12px 0}
  #logbox{background:#0b1020;color:#c7d2fe;border-radius:10px;border:1px solid #1e293b;padding:12px;height:240px;overflow:auto;font:12px/1.45 ui-monospace,Consolas}
  a{color:#0ea5e9;text-decoration:none} a:hover{text-decoration:underline}
  .small{font-size:12px;color:var(--muted)}
  .stat-grid{display:grid;grid-template-columns:1fr;gap:8px}
  .pair{display:flex;gap:10px;align-items:center}
  .val{font-weight:700}
  .right{margin-left:auto}
  @media(min-width:760px){ .grid{grid-template-columns:1fr 1fr} .stat-grid{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<header class="wrap">
  <h1>GoldenPrice Admin <span class="pill">Light</span></h1>
  <div class="sub">Use your admin token for manual overrides. Autoupdate rotates data sources in the backend.</div>
</header>

<main class="wrap">

  <!-- STATUS -->
  <section class="card">
    <div class="row">
      <h3 class="grow" style="margin:0">Status</h3>
      <button id="btnUpdateAll" class="btn">ğŸ”„ Update All Now</button>
    </div>
    <div class="line"></div>
    <div class="stat-grid">
      <div><label>Last updates</label><pre id="lastBox" class="kv">{}</pre></div>
      <div><label>API keys availability</label><pre id="keysBox" class="kv">{}</pre></div>
    </div>
    <div class="hint">Status auto-refreshes every 3 minutes. See real-time logs below.</div>
  </section>

  <!-- TOKEN -->
  <section class="card">
    <label>Admin token</label>
    <input id="token" placeholder="Bearer token" />
    <div class="hint">Saved to your browser only. Required for the manual Save buttons below.</div>
  </section>

  <!-- GOLD -->
  <section class="card">
    <div class="row">
      <label class="grow">Manual set â€” Gold</label>
      <span id="goldNow" class="small">â€¦</span>
    </div>
    <div class="row">
      <input id="goldUsd" class="grow" placeholder="USD e.g. 3990.21" inputmode="decimal" />
      <button id="saveGold" class="btn">Save</button>
    </div>
  </section>

  <!-- SILVER -->
  <section class="card">
    <div class="row">
      <label class="grow">Manual set â€” Silver</label>
      <span id="silverNow" class="small">â€¦</span>
    </div>
    <div class="row">
      <input id="silverUsd" class="grow" placeholder="USD e.g. 46.2" inputmode="decimal" />
      <button id="saveSilver" class="btn">Save</button>
    </div>
  </section>

  <!-- SILVERX -->
  <section class="card">
    <div class="row">
      <label class="grow">Manual set â€” SilverX</label>
      <span id="silverxNow" class="small">â€¦</span>
    </div>
    <div class="row">
      <input id="silverxUsd" class="grow" placeholder="USD e.g. 0.01234" inputmode="decimal" />
      <button id="saveSilverX" class="btn">Save</button>
    </div>
    <div class="hint">SilverX pulls live from DexScreener/Pancake (pair/contract is configured on the server). Manual save overrides cache.</div>
  </section>

  <!-- CRYPTO -->
  <section class="card">
    <div class="row">
      <label class="grow">Manual set â€” Crypto</label>
      <span id="cryptoNow" class="small">â€¦</span>
    </div>
    <div class="row">
      <input id="cryptoSym" style="max-width:160px" placeholder="Symbol (BTC, ETHâ€¦)" />
      <input id="cryptoUsd" class="grow" placeholder="USD" inputmode="decimal" />
      <button id="saveCrypto" class="btn">Save</button>
    </div>
    <div class="hint">Auto updates from CoinGecko/CoinCap. Manual set needs <b>symbol</b> + <b>USD</b>.</div>
  </section>

  <!-- METALS -->
  <section class="card">
    <div class="row">
      <label class="grow">Manual set â€” Metals</label>
      <span id="metalsNow" class="small">â€¦</span>
    </div>
    <div class="row">
      <input id="metalCode" style="max-width:180px" placeholder="Code (XAU, XAG, XPTâ€¦)" />
      <input id="metalUsd" class="grow" placeholder="USD" inputmode="decimal" />
      <button id="saveMetal" class="btn">Save</button>
    </div>
    <div class="hint">Codes: XAU, XAG, XPT, XPD, CU, AL, NI, ZN, PB, SN â€¦</div>
  </section>

  <!-- OIL & GAS -->
  <section class="card">
    <div class="row">
      <label class="grow">Manual set â€” Oil & Gas</label>
      <span id="oilNow" class="small">â€¦</span>
    </div>
    <div class="row">
      <select id="oilKey" style="max-width:180px">
        <option value="WTI">WTI</option>
        <option value="BRENT">BRENT</option>
        <option value="NG">NG</option>
      </select>
      <input id="oilUsd" class="grow" placeholder="USD" inputmode="decimal" />
      <button id="saveOil" class="btn">Save</button>
    </div>
    <div class="hint">Auto updates via AlphaVantage/MetalPriceAPI according to rotation. Choose the leg you want to override.</div>
  </section>

  <!-- QUICK LINKS -->
  <section class="card">
    <label>Quick test links</label>
    <div class="grid">
      <div class="kv">
        <a href="/api/gold" target="_blank">/api/gold</a><br>
        <a href="/api/silver" target="_blank">/api/silver</a><br>
        <a href="/api/silverx" target="_blank">/api/silverx</a><br>
        <a href="/api/crypto/bitcoin" target="_blank">/api/crypto/bitcoin</a><br>
        <a href="/api/oilgas" target="_blank">/api/oilgas</a><br>
        <a href="/api/metals" target="_blank">/api/metals</a><br>
        <a href="/api/status" target="_blank">/api/status</a><br>
      </div>
      <div>
        <div class="hint">
          â€¢ <b>Update All Now</b> = ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ø± (Ù„Ø§ ÙŠØ­ØªØ§Ø¬ ØªÙˆÙƒÙ†).<br>
          â€¢ <b>Save</b> = ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù„Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (ÙŠØ­ØªØ§Ø¬ Bearer token).<br>
          â€¢ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙŠØ¯ÙˆÙŠØ© ØªÙØ®Ø²ÙÙ‘Ù† ÙÙŠ Ø§Ù„ÙƒØ§Ø´ ÙˆØªÙØ±Ø¬Ø¹ Ù„Ù„ÙØ±ÙˆÙ†Øª Ø¥Ù†Ø¯ ÙÙˆØ±Ù‹Ø§ Ø­ØªÙ‰ ÙŠØ¹ÙˆØ¯ Ø£ÙŠ API Ù„Ù„ØªØ¹Ø§ÙÙŠ.
        </div>
      </div>
    </div>
  </section>

  <!-- LOG VIEWER -->
  <section class="card">
    <div class="row">
      <label class="grow">Live Logs</label>
      <button id="btnPing" class="btn ghost">Ping status</button>
      <button id="btnClearLog" class="btn ghost">Clear</button>
    </div>
    <div id="logbox"></div>
  </section>

  <div class="small">Â© GoldenPrice â€” Admin Light Panel</div>

</main>

<script>
/* ========= helpers ========= */
const $ = sel => document.querySelector(sel);
const logbox = $('#logbox');
const log = (m, cls='')=>{
  const t = new Date().toLocaleTimeString();
  const line = document.createElement('div');
  line.innerHTML = `[${t}] ${m}`;
  if(cls) line.className = cls;
  logbox.prepend(line);
};
const jget = async (url)=>{
  const r = await fetch(url);
  let j={};
  try{ j = await r.json(); }catch(e){}
  if(!r.ok) throw new Error((j && (j.error||j.message)) || 'HTTP '+r.status);
  return j;
};
const jpost = async (url, body, token)=>{
  const r = await fetch(url,{
    method:'POST',
    headers:{'Content-Type':'application/json', ...(token?{'Authorization':'Bearer '+token}:{})},
    body: JSON.stringify(body||{})
  });
  let j={};
  try{ j = await r.json(); }catch(e){}
  if(!r.ok) throw new Error((j && (j.error||j.message)) || 'HTTP '+r.status);
  return j;
};
const fmt = (v)=> (v==null?'â€”':(typeof v==='number'? new Intl.NumberFormat('en-US',{maximumFractionDigits:6}).format(v) : v));

/* ========= state ========= */
const els = {
  token: $('#token'),
  lastBox: $('#lastBox'),
  keysBox: $('#keysBox'),
  goldNow: $('#goldNow'),
  silverNow: $('#silverNow'),
  silverxNow: $('#silverxNow'),
  cryptoNow: $('#cryptoNow'),
  metalsNow: $('#metalsNow'),
  oilNow: $('#oilNow'),
  goldUsd: $('#goldUsd'),
  silverUsd: $('#silverUsd'),
  silverxUsd: $('#silverxUsd'),
  cryptoSym: $('#cryptoSym'),
  cryptoUsd: $('#cryptoUsd'),
  metalCode: $('#metalCode'),
  metalUsd: $('#metalUsd'),
  oilKey: $('#oilKey'),
  oilUsd: $('#oilUsd'),
};

/* ========= init token ========= */
els.token.value = localStorage.getItem('gp_admin_token') || '';
els.token.addEventListener('change', ()=>localStorage.setItem('gp_admin_token', els.token.value.trim()));

/* ========= status & current values ========= */
async function refreshStatus(){
  try{
    const s = await jget('/api/status');
    els.lastBox.textContent = JSON.stringify(s.last||{}, null, 2);
    els.keysBox.textContent = JSON.stringify(s.keys||{}, null, 2);
    log('ğŸ“Š Status OK');
  }catch(e){
    log('Status error: '+e.message, 'err');
  }
}
async function refreshCurrent(){
  // gold
  try{
    const j = await jget('/api/gold');
    const usd = j && (j.usd || j.value || j.price || j.data?.usd);
    els.goldNow.textContent = usd? `Current: $${fmt(usd)}` : 'âš ï¸ No data';
  }catch(e){ els.goldNow.textContent = 'âš ï¸ No data'; log('gold: '+e.message, 'warn'); }

  // silver
  try{
    const j = await jget('/api/silver');
    const usd = j && (j.usd || j.value || j.price);
    els.silverNow.textContent = usd? `Current: $${fmt(usd)}` : 'âš ï¸ No data';
  }catch(e){ els.silverNow.textContent = 'âš ï¸ No data'; log('silver: '+e.message, 'warn'); }

  // silverx
  try{
    const j = await jget('/api/silverx');
    const usd = j && (j.usd || j.value || j.price);
    els.silverxNow.textContent = usd? `Current: $${fmt(usd)}` : 'âš ï¸ No data';
  }catch(e){ els.silverxNow.textContent = 'âš ï¸ No data'; log('silverx: '+e.message, 'warn'); }

  // crypto (default BTC for display)
  try{
    const j = await jget('/api/crypto/bitcoin');
    const usd = j && (j.usd || j.value || j.price);
    els.cryptoNow.textContent = usd? `BTC: $${fmt(usd)}` : 'âš ï¸ No data';
  }catch(e){ els.cryptoNow.textContent = 'âš ï¸ No data'; log('crypto: '+e.message, 'warn'); }

  // metals (summary)
  try{
    const j = await jget('/api/metals');
    const cnt = j && j.value ? Object.keys(j.value).length : 0;
    els.metalsNow.textContent = cnt? `Symbols cached: ${cnt}` : 'âš ï¸ No data';
  }catch(e){ els.metalsNow.textContent = 'âš ï¸ No data'; log('metals: '+e.message, 'warn'); }

  // oilgas (summary)
  try{
    const j = await jget('/api/oilgas');
    const keys = j && j.value ? Object.keys(j.value) : [];
    const show = keys.map(k=>`${k}: $${fmt(j.value[k])}`).join(' â€¢ ');
    els.oilNow.textContent = keys.length? show : 'âš ï¸ No data';
  }catch(e){ els.oilNow.textContent = 'âš ï¸ No data'; log('oilgas: '+e.message, 'warn'); }
}

/* ========= actions ========= */
$('#btnUpdateAll').addEventListener('click', async ()=>{
  try{
    log('ğŸ”„ Update-all requested...');
    const j = await jpost('/api/updateall', {});
    log('âœ… updateall: '+JSON.stringify(j));
    await refreshStatus();
    await refreshCurrent();
  }catch(e){ log('updateall error: '+e.message, 'err'); }
});
$('#btnPing').addEventListener('click', ()=>{ refreshStatus(); refreshCurrent(); });
$('#btnClearLog').addEventListener('click', ()=>{ logbox.innerHTML=''; });

async function saveWith(url, body){
  const token = els.token.value.trim();
  if(!token){ alert('Enter admin token first'); return; }
  try{
    log('POST '+url+' '+JSON.stringify(body));
    const j = await jpost(url, body, token);
    log('âœ… saved: '+JSON.stringify(j), 'ok');
    await refreshCurrent();
  }catch(e){ log('âŒ save error: '+e.message, 'err'); alert(e.message); }
}

/* bind save buttons */
$('#saveGold').addEventListener('click', ()=> saveWith('/admin/set/gold',   {usd: parseFloat(els.goldUsd.value)}));
$('#saveSilver').addEventListener('click', ()=> saveWith('/admin/set/silver', {usd: parseFloat(els.silverUsd.value)}));
$('#saveSilverX').addEventListener('click', ()=> saveWith('/admin/set/silverx',{usd: parseFloat(els.silverxUsd.value)}));
$('#saveCrypto').addEventListener('click', ()=> saveWith('/admin/set/crypto',{symbol: els.cryptoSym.value.trim().toUpperCase(), usd: parseFloat(els.cryptoUsd.value)}));
$('#saveMetal').addEventListener('click', ()=> saveWith('/admin/set/metals',{code: els.metalCode.value.trim().toUpperCase(), usd: parseFloat(els.metalUsd.value)}));
$('#saveOil').addEventListener('click', ()=> saveWith('/admin/set/oilgas',{key: els.oilKey.value.trim().toUpperCase(), usd: parseFloat(els.oilUsd.value)}));

/* boot */
(async function boot(){
  log('Admin panel loaded.');
  await refreshStatus();
  await refreshCurrent();
  setInterval(refreshStatus, 180000); // ÙƒÙ„ 3 Ø¯Ù‚Ø§Ø¦Ù‚
})();
</script>
</body>
</html>
