<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GoldenPrice Admin Panel</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f7fa;
    color: #333;
    margin: 0;
    padding: 20px;
  }
  h1 {
    text-align: center;
    color: #0056b3;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: white;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
  }
  th {
    background: #e6f0ff;
  }
  tr.ok { background: #eaffea; }
  tr.err { background: #ffeaea; }
  tr.manual { background: #fff7e6; }
  button {
    padding: 6px 12px;
    margin: 2px;
    cursor: pointer;
    border: none;
    border-radius: 4px;
  }
  button.update { background: #007bff; color: white; }
  button.restart { background: #dc3545; color: white; }
  button:hover { opacity: 0.8; }
  #log {
    background: #000;
    color: #0f0;
    padding: 10px;
    height: 150px;
    overflow-y: scroll;
    font-size: 12px;
  }
</style>
</head>
<body>

<h1>GoldenPrice Admin Panel</h1>
<p style="text-align:center;">Manage & monitor all price sources (Auto + Manual)</p>

<table id="dataTable">
  <thead>
    <tr>
      <th>Category</th>
      <th>Symbol</th>
      <th>Price (USD)</th>
      <th>Source</th>
      <th>Status</th>
      <th>Last Update</th>
      <th>Set Manual</th>
      <th>Restart Cache</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Log Viewer</h3>
<div id="log">Console Log Output...</div>

<script>
const API = "https://goldenprice-backend.onrender.com";
const TOKEN = "ADMIN_12345";

const categories = {
  gold: ["XAU"],
  silver: ["XAG"],
  crypto: ["BTC", "ETH", "SLX"],
  metals: ["copper", "platinum"],
  energy: ["WTI", "GAS"],
  forex: ["USD_EGP"]
};

async function fetchData() {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  for (let cat in categories) {
    for (let sym of categories[cat]) {
      try {
        const res = await fetch(`${API}/api/${cat}/${sym}`);
        const data = await res.json();
        const tr = document.createElement("tr");
        if (data.price) tr.className = "ok";
        else tr.className = "err";
        tr.innerHTML = `
          <td>${cat}</td>
          <td>${sym}</td>
          <td>${data.price || "‚Äî"}</td>
          <td>${data.source || "‚Äî"}</td>
          <td>${data.price ? "‚úÖ OK" : "‚ùå Error"}</td>
          <td>${data.updated || "‚Äî"}</td>
          <td><button class="update" onclick="setManual('${cat}','${sym}')">Set Manual</button></td>
          <td><button class="restart" onclick="restartCache('${cat}','${sym}')">Restart</button></td>
        `;
        tbody.appendChild(tr);
      } catch (e) {
        logLine(`Error fetching ${cat}/${sym}`);
      }
    }
  }
}

async function setManual(category, symbol) {
  const newPrice = prompt(`Enter new price for ${symbol}:`);
  if (!newPrice) return;
  const res = await fetch(`${API}/api/manual`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token: TOKEN, category, symbol, price: newPrice })
  });
  const data = await res.json();
  if (data.success) {
    logLine(`‚úÖ Manual update: ${category}/${symbol} = ${newPrice}`);
    fetchData();
  } else logLine(`‚ùå Manual update failed for ${category}/${symbol}`);
}

async function restartCache(category, symbol) {
  const res = await fetch(`${API}/api/restart`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token: TOKEN, category, symbol })
  });
  const data = await res.json();
  logLine(`üîÅ Cache cleared for ${category}/${symbol}`);
  fetchData();
}

function logLine(msg) {
  const log = document.querySelector("#log");
  log.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
  log.scrollTop = log.scrollHeight;
}

fetchData();
setInterval(fetchData, 60000);
</script>

</body>
</html>
