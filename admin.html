<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin • GoldenPrice</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;margin:16px;background:#fff;color:#111}
  h1{margin:0 0 12px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  input,select,button{padding:8px;border:1px solid #ccc;border-radius:6px}
  button{cursor:pointer}
  .grid{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .card{border:1px solid #e4e4e4;border-radius:10px;padding:12px;background:#fafafa}
  .row{display:flex;gap:6px;align-items:center;margin:6px 0}
  .ok{color:#0a7}
  .err{color:#c00}
  .muted{color:#666;font-size:12px}
  .mono{font-family:ui-monospace,Consolas,monospace}
  .log{white-space:pre-wrap;background:#f7f7f7;border-radius:6px;padding:8px;border:1px dashed #ddd;height:160px;overflow:auto}
</style>
</head>
<body>
<h1>Admin • GoldenPrice</h1>

<div class="bar">
  <label>Admin Token</label>
  <input id="tok" placeholder="ADMIN_12345" value="">
  <button onclick="loadAll()">Ping & Load</button>
  <button onclick="refreshAll()">Update All Now</button>
  <button onclick="clearCache()">Clear Cache</button>
  <span id="ping" class="muted"></span>
</div>

<div class="grid" id="cards"></div>

<h3>Manual Set</h3>
<div class="row">
  <select id="sym">
    <optgroup label="Precious">
      <option>GOLD</option>
      <option>SILVER</option>
    </optgroup>
    <optgroup label="Crypto">
      <option>BTC</option>
      <option>ETH</option>
      <option>SLX</option>
    </optgroup>
    <optgroup label="FX">
      <option>FX_USD_EGP</option>
    </optgroup>
    <optgroup label="Metals">
      <option>PLATINUM</option><option>PALLADIUM</option><option>COPPER</option>
      <option>ALUMINUM</option><option>NICKEL</option><option>ZINC</option>
      <option>LEAD</option><option>TIN</option><option>IRON</option>
      <option>STEEL</option><option>COBALT</option><option>LITHIUM</option>
      <option>URANIUM</option>
    </optgroup>
    <optgroup label="Energy">
      <option>WTI</option><option>BRENT</option><option>NATGAS</option>
    </optgroup>
  </select>
  <input id="val" placeholder="price (USD)">
  <button onclick="setManual()">Set Manual</button>
</div>

<h3>Log</h3>
<div id="log" class="log"></div>

<script>
const $ = sel => document.querySelector(sel);
const log = (m)=> { const el=$("#log"); el.textContent += (m + "\n"); el.scrollTop = el.scrollHeight; };

async function api(path, opts={}){
  const tok = $("#tok").value.trim();
  const headers = opts.headers || {};
  if (tok) headers["X-Admin-Token"] = tok;
  const r = await fetch(path, {...opts, headers});
  if(!r.ok) throw new Error("HTTP "+r.status);
  return await r.json();
}

async function loadAll(){
  try{
    const h = await fetch("/api/health"); $("#ping").textContent = h.ok?"OK":"";
  }catch{}
  await renderCards();
}

async function renderCards(){
  let j; 
  try{ j = await api("/api/cache"); }catch(e){ log("cache err: "+e.message); return; }
  const c = $("#cards"); c.innerHTML = "";
  const items = Object.entries(j.prices).sort((a,b)=>a[0].localeCompare(b[0]));
  for (const [k, v] of items){
    const t = new Date(v.t||0).toLocaleString();
    const div = document.createElement("div");
    div.className="card";
    div.innerHTML = `
      <div class="row"><b>${k}</b></div>
      <div class="row">Price: <span class="mono">${v.price}</span> <span class="muted">${v.unit||""}</span></div>
      <div class="row">Source: <span class="muted">${v.src||""}</span></div>
      <div class="row muted">Updated: ${t}</div>
    `;
    c.appendChild(div);
  }
}

async function refreshAll(){
  try{
    const j = await api("/api/admin/refresh", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ what:"all" }) });
    log("refreshed: "+JSON.stringify(j.lastUpdate));
    await renderCards();
  }catch(e){ log("refresh err: "+e.message); }
}

async function clearCache(){
  try{
    const j = await api("/api/admin/cache/clear", { method:"POST" });
    log("cache cleared");
    await renderCards();
  }catch(e){ log("clear err: "+e.message); }
}

async function setManual(){
  const symbol = $("#sym").value.trim();
  const price = Number($("#val").value.trim());
  if (!symbol || !price) { alert("Enter symbol & price"); return; }
  try{
    const j = await api("/api/admin/set", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ symbol, price }) });
    log("manual set: "+symbol+"="+price);
    $("#val").value="";
    await renderCards();
  }catch(e){ log("manual err: "+e.message); }
}

// auto refresh view every 20s
setInterval(renderCards, 20000);
</script>
</body>
</html>
